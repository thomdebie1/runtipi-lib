{
  "schemaVersion": 2,
  "$schema": "https://schemas.runtipi.io/dynamic-compose.json",
  "services": [
    {
      "name": "dawarich_app",
      "image": "freikin/dawarich:latest",
      "isMain": true,
      "internalPort": 3000,
      "entrypoint": "web-entrypoint.sh",
      "command": ["bin/rails", "server", "-p", "3000", "-b", "::"],
      "environment": [
        { "key": "RAILS_ENV", "value": "production" },
        { "key": "REDIS_URL", "value": "redis://dawarich_redis:6379" },
        { "key": "DATABASE_HOST", "value": "dawarich_db" },
        { "key": "DATABASE_PORT", "value": "5432" },
        { "key": "DATABASE_USERNAME", "value": "postgres" },
        { "key": "DATABASE_PASSWORD", "value": "${DAWARICH_DB_PASSWORD}" },
        { "key": "DATABASE_NAME", "value": "dawarich" },
        { "key": "APPLICATION_HOSTS", "value": "${APP_DOMAIN}" },
        { "key": "APPLICATION_PROTOCOL", "value": "${APP_PROTOCOL}" },
        { "key": "TIME_ZONE", "value": "Europe/Amsterdam" },
        { "key": "SECRET_KEY_BASE", "value": "${DAWARICH_SECRET_KEY_BASE}" },
        { "key": "SELF_HOSTED", "value": true },
        { "key": "STORE_GEODATA", "value": true },
        { "key": "RAILS_LOG_TO_STDOUT", "value": true }
      ],
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/public", "containerPath": "/var/app/public" },
        { "hostPath": "${APP_DATA_DIR}/watched", "containerPath": "/var/app/tmp/imports/watched" },
        { "hostPath": "${APP_DATA_DIR}/storage", "containerPath": "/var/app/storage" },
        { "hostPath": "${APP_DATA_DIR}/db-backup", "containerPath": "/dawarich_db_data" }
      ],
      "dependsOn": ["dawarich_db", "dawarich_redis"]
    },

    {
      "name": "dawarich_sidekiq",
      "image": "freikin/dawarich:latest",
      "entrypoint": "sidekiq-entrypoint.sh",
      "command": ["sidekiq"],
      "environment": [
        { "key": "RAILS_ENV", "value": "production" },
        { "key": "REDIS_URL", "value": "redis://dawarich_redis:6379" },
        { "key": "DATABASE_HOST", "value": "dawarich_db" },
        { "key": "DATABASE_PORT", "value": "5432" },
        { "key": "DATABASE_USERNAME", "value": "postgres" },
        { "key": "DATABASE_PASSWORD", "value": "${DAWARICH_DB_PASSWORD}" },
        { "key": "DATABASE_NAME", "value": "dawarich" },
        { "key": "APPLICATION_PROTOCOL", "value": "${APP_PROTOCOL}" },
        { "key": "SECRET_KEY_BASE", "value": "${DAWARICH_SECRET_KEY_BASE}" },
        { "key": "SELF_HOSTED", "value": true },
        { "key": "STORE_GEODATA", "value": true },
        { "key": "RAILS_LOG_TO_STDOUT", "value": true }
      ],
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/public", "containerPath": "/var/app/public" },
        { "hostPath": "${APP_DATA_DIR}/watched", "containerPath": "/var/app/tmp/imports/watched" },
        { "hostPath": "${APP_DATA_DIR}/storage", "containerPath": "/var/app/storage" }
      ],
      "dependsOn": ["dawarich_app"]
    },

    {
      "name": "dawarich_db",
      "image": "postgis/postgis:17-3.5-alpine",
      "environment": [
        { "key": "POSTGRES_USER", "value": "postgres" },
        { "key": "POSTGRES_PASSWORD", "value": "${DAWARICH_DB_PASSWORD}" },
        { "key": "POSTGRES_DB", "value": "dawarich" }
      ],
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/db", "containerPath": "/var/lib/postgresql/data" },
        { "hostPath": "${APP_DATA_DIR}/shared", "containerPath": "/var/shared" }
      ]
    },

    {
      "name": "dawarich_redis",
      "image": "redis:7.4-alpine",
      "command": ["redis-server"],
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/redis", "containerPath": "/data" }
      ]
    }
  ]
}
