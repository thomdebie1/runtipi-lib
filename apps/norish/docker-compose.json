{
  "schemaVersion": 2,
  "$schema": "https://schemas.runtipi.io/dynamic-compose.json",
  "services": [
    {
      "name": "norish",
      "image": "norishapp/norish:latest",
      "isMain": true,
      "internalPort": 3000,
      "user": "1000:1000",
      "environment": [
        { "key": "AUTH_URL", "value": "${APP_PROTOCOL}://${APP_DOMAIN}" },
        { "key": "DATABASE_URL", "value": "postgres://postgres:${NORISH_DB_PASSWORD}@db:5432/norish" },
        { "key": "MASTER_KEY", "value": "${NORISH_MASTER_KEY}" },
        { "key": "CHROME_WS_ENDPOINT", "value": "ws://chrome-headless:3000" },
        { "key": "REDIS_URL", "value": "redis://redis:6379" },
        { "key": "PASSWORD_AUTH_ENABLED", "value": true }
      ],
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/uploads", "containerPath": "/app/uploads", "readOnly": false }
      ],
      "dependsOn": ["db", "redis", "chrome-headless"]
    },
    {
      "name": "db",
      "image": "postgres:17-alpine",
      "environment": [
        { "key": "POSTGRES_USER", "value": "postgres" },
        { "key": "POSTGRES_PASSWORD", "value": "${NORISH_DB_PASSWORD}" },
        { "key": "POSTGRES_DB", "value": "norish" }
      ],
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/db", "containerPath": "/var/lib/postgresql/data", "readOnly": false }
      ]
    },
    {
      "name": "redis",
      "image": "redis:8.4.0",
      "volumes": [
        { "hostPath": "${APP_DATA_DIR}/redis", "containerPath": "/data", "readOnly": false }
      ]
    },
    {
      "name": "chrome-headless",
      "image": "zenika/alpine-chrome:latest",
      "command": [
        "--no-sandbox",
        "--disable-gpu",
        "--disable-dev-shm-usage",
        "--remote-debugging-address=0.0.0.0",
        "--remote-debugging-port=3000",
        "--headless"
      ]
    }
  ]
}
